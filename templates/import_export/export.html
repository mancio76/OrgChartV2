{% extends "base/layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">{{ page_title }}</h1>
                    <p class="text-muted mb-0">{{ page_subtitle }}</p>
                </div>
                <a href="/import-export" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    Torna Indietro
                </a>
            </div>
        </div>
    </div>

    <!-- Export Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-download me-2"></i>
                        Configurazione Esportazione
                    </h5>
                </div>
                <div class="card-body">
                    <form id="exportForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        
                        <!-- Entity Types Selection -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    Tipi di Entità da Esportare
                                </label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-success" id="selectAllEntities">
                                        <i class="bi bi-check-all me-1"></i>
                                        Tutti
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="selectNoneEntities">
                                        <i class="bi bi-x me-1"></i>
                                        Nessuno
                                    </button>
                                </div>
                            </div>
                            <div class="row entity-selection-grid">
                                {% for entity in entity_types %}
                                <div class="col-md-6">
                                    <div class="form-check export-entity-checkbox">
                                        <input class="form-check-input" type="checkbox" 
                                               name="entity_types" value="{{ entity.value }}" 
                                               id="entity_{{ entity.value }}" checked>
                                        <label class="form-check-label" for="entity_{{ entity.value }}">
                                            <strong>{{ entity.label }}</strong>
                                            <br>
                                            <small class="text-muted">{{ entity.description }}</small>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">
                                Seleziona almeno un tipo di entità da esportare. L'ordine di esportazione rispetterà le dipendenze.
                            </div>
                        </div>

                        <!-- Export Format -->
                        <div class="mb-4">
                            <label for="export_format" class="form-label">
                                <i class="bi bi-file-earmark me-2"></i>
                                Formato di Esportazione
                            </label>
                            <select class="form-select" id="export_format" name="export_format">
                                {% for format in export_formats %}
                                <option value="{{ format.value }}" 
                                        {% if format.value == 'json' %}selected{% endif %}
                                        data-description="{{ format.description }}">
                                    {{ format.label }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text" id="formatDescription">
                                JSON crea un file unico strutturato, CSV crea file separati per tipo.
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear me-2"></i>
                                Opzioni Avanzate
                            </h6>
                            
                            <!-- Historical Data -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="include_historical" name="include_historical" checked>
                                    <label class="form-check-label" for="include_historical">
                                        <strong>Includi Dati Storici</strong>
                                        <br>
                                        <small class="text-muted">
                                            Include tutte le versioni degli incarichi e dati archiviati
                                        </small>
                                    </label>
                                </div>
                            </div>

                            <!-- Include Metadata -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="include_metadata" name="include_metadata" checked>
                                    <label class="form-check-label" for="include_metadata">
                                        <strong>Includi Metadati</strong>
                                        <br>
                                        <small class="text-muted">
                                            Include informazioni su data di esportazione, versione e statistiche
                                        </small>
                                    </label>
                                </div>
                            </div>

                            <!-- Compress Output -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="compress_output" name="compress_output">
                                    <label class="form-check-label" for="compress_output">
                                        <strong>Comprimi File</strong>
                                        <br>
                                        <small class="text-muted">
                                            Crea un archivio ZIP con tutti i file esportati
                                        </small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Date Range -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="bi bi-calendar-range me-2"></i>
                                Intervallo Temporale (Opzionale)
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="date_from" class="form-label small">Data Inizio</label>
                                    <input type="date" class="form-control" id="date_from" name="date_from">
                                </div>
                                <div class="col-md-6">
                                    <label for="date_to" class="form-label small">Data Fine</label>
                                    <input type="date" class="form-control" id="date_to" name="date_to">
                                </div>
                            </div>
                            <div class="form-text">
                                Filtra i dati per intervallo temporale. Lascia vuoto per esportare tutti i dati disponibili.
                            </div>
                        </div>

                        <!-- File Prefix -->
                        <div class="mb-4">
                            <label for="file_prefix" class="form-label">
                                <i class="bi bi-tag me-2"></i>
                                Prefisso Nome File
                            </label>
                            <input type="text" class="form-control" id="file_prefix" name="file_prefix" 
                                   value="orgchart_export" placeholder="orgchart_export">
                            <div class="form-text">
                                Prefisso per i nomi dei file generati. Verrà aggiunta automaticamente la data.
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-download me-2"></i>
                                Genera Esportazione
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="col-lg-4">
            <div class="card border-success">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle text-success me-2"></i>
                        Guida Esportazione
                    </h6>
                </div>
                <div class="card-body">
                    <h6 class="text-success">Ordine di Esportazione</h6>
                    <ol class="small mb-3">
                        <li>Tipi di Unità</li>
                        <li>Temi Tipi Unità</li>
                        <li>Unità</li>
                        <li>Titoli Lavorativi</li>
                        <li>Persone</li>
                        <li>Incarichi</li>
                    </ol>

                    <h6 class="text-success">Formato JSON</h6>
                    <ul class="small mb-3">
                        <li>File unico strutturato</li>
                        <li>Include metadati di esportazione</li>
                        <li>Mantiene relazioni tra entità</li>
                        <li>Ideale per backup completi</li>
                        <li>Supporta re-importazione diretta</li>
                    </ul>

                    <h6 class="text-success">Formato CSV</h6>
                    <ul class="small mb-3">
                        <li>File separati per ogni tipo di entità</li>
                        <li>Compatibile con Excel e fogli di calcolo</li>
                        <li>Facile da analizzare e modificare</li>
                        <li>Ideale per elaborazioni specifiche</li>
                        <li>Supporta importazione parziale</li>
                    </ul>

                    <h6 class="text-success">Sicurezza e Audit</h6>
                    <p class="small mb-0">
                        Tutte le esportazioni vengono registrate per audit con timestamp e utente. 
                        I file generati sono disponibili per il download per 24 ore, poi vengono archiviati automaticamente.
                    </p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3 border-info">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightning text-info me-2"></i>
                        Azioni Rapide
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" id="exportAllBtn">
                            <i class="bi bi-database me-2"></i>
                            Backup Completo (JSON)
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" id="exportCurrentBtn">
                            <i class="bi bi-calendar-check me-2"></i>
                            Solo Dati Correnti
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" id="exportAssignmentsBtn">
                            <i class="bi bi-person-badge me-2"></i>
                            Solo Incarichi Attivi
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" id="exportStructureBtn">
                            <i class="bi bi-diagram-3 me-2"></i>
                            Solo Struttura Organizzativa
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Exports -->
            <div class="card mt-3 border-secondary">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-clock-history text-secondary me-2"></i>
                        Esportazioni Recenti
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recentExports" class="small">
                        <div class="text-muted text-center py-2">
                            <i class="bi bi-hourglass me-2"></i>
                            Caricamento...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-hourglass-split me-2"></i>
                    Generazione Esportazione
                </h5>
            </div>
            <div class="modal-body">
                <!-- Main Progress Section -->
                <div class="text-center mb-4">
                    <div class="spinner-border text-success mb-3" role="status" id="progressSpinner">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" 
                             id="progressBar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                             aria-label="Progresso esportazione">
                        </div>
                    </div>
                    <h6 class="mb-2" id="progressMessage">Inizializzazione esportazione...</h6>
                    <small class="text-muted" id="progressDetails"></small>
                </div>

                <!-- Export Statistics -->
                <div id="exportStats" class="d-none">
                    <div class="row text-center mb-3 export-progress-stats">
                        <div class="col-3">
                            <div class="card export-status-card">
                                <div class="card-body py-2">
                                    <div class="export-status-number text-success" id="recordsExported">0</div>
                                    <div class="export-status-label text-muted">Esportati</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card export-status-card">
                                <div class="card-body py-2">
                                    <div class="export-status-number text-info" id="filesGenerated">0</div>
                                    <div class="export-status-label text-muted">File</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card export-status-card">
                                <div class="card-body py-2">
                                    <div class="export-status-number text-primary" id="totalSize">0 KB</div>
                                    <div class="export-status-label text-muted">Dimensione</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card export-status-card">
                                <div class="card-body py-2">
                                    <div class="export-status-number text-warning" id="processingTime">0s</div>
                                    <div class="export-status-label text-muted">Tempo</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Entity Processing -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-medium">Entità Corrente:</span>
                            <span class="badge bg-success" id="currentEntity">-</span>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-info entity-progress-indicator" role="progressbar" 
                                 style="width: 0%" id="entityProgress"
                                 aria-label="Progresso entità corrente">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Section -->
                <div id="downloadSection" class="d-none">
                    <div class="alert alert-success">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Esportazione Completata!</strong>
                        </div>
                        <p class="mb-0 small">I file sono pronti per il download. Saranno disponibili per 24 ore.</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="mb-2">File Generati:</h6>
                        <div id="downloadLinks" class="d-grid gap-2">
                            <!-- Download links will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="d-none">
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Errore durante l'esportazione</strong>
                        </div>
                        <p class="mb-0 small" id="errorMessage">Si è verificato un errore imprevisto.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="cancelBtn">
                    <i class="bi bi-x-circle me-2"></i>
                    Annulla
                </button>
                <button type="button" class="btn btn-secondary d-none" id="viewStatusBtn">
                    <i class="bi bi-eye me-2"></i>
                    Visualizza Dettagli
                </button>
                <button type="button" class="btn btn-success d-none" id="downloadAllBtn">
                    <i class="bi bi-download me-2"></i>
                    Scarica Tutto
                </button>
                <button type="button" class="btn btn-primary d-none" id="closeBtn">
                    <i class="bi bi-check-circle me-2"></i>
                    Chiudi
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const exportForm = document.getElementById('exportForm');
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const progressBar = document.getElementById('progressBar');
    const progressMessage = document.getElementById('progressMessage');
    const progressDetails = document.getElementById('progressDetails');
    const progressSpinner = document.getElementById('progressSpinner');
    const exportStats = document.getElementById('exportStats');
    const downloadSection = document.getElementById('downloadSection');
    const errorSection = document.getElementById('errorSection');
    const viewStatusBtn = document.getElementById('viewStatusBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const closeBtn = document.getElementById('closeBtn');
    
    // Status detail elements
    const recordsExported = document.getElementById('recordsExported');
    const filesGenerated = document.getElementById('filesGenerated');
    const totalSize = document.getElementById('totalSize');
    const processingTime = document.getElementById('processingTime');
    const currentEntity = document.getElementById('currentEntity');
    const entityProgress = document.getElementById('entityProgress');
    const downloadLinks = document.getElementById('downloadLinks');
    const errorMessage = document.getElementById('errorMessage');
    
    let currentOperationId = null;
    let statusCheckInterval = null;
    let startTime = null;

    // Form submission
    exportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm();
    });

    // Quick action buttons
    document.getElementById('exportAllBtn').addEventListener('click', function() {
        selectAllEntities();
        document.getElementById('export_format').value = 'json';
        document.getElementById('include_historical').checked = true;
        document.getElementById('include_metadata').checked = true;
        document.getElementById('compress_output').checked = true;
        submitForm();
    });

    document.getElementById('exportCurrentBtn').addEventListener('click', function() {
        selectAllEntities();
        document.getElementById('include_historical').checked = false;
        document.getElementById('include_metadata').checked = true;
        submitForm();
    });

    document.getElementById('exportAssignmentsBtn').addEventListener('click', function() {
        selectNoneEntities();
        const assignmentsCheckbox = document.querySelector('input[value="assignments"]');
        if (assignmentsCheckbox) {
            assignmentsCheckbox.checked = true;
        }
        document.getElementById('include_historical').checked = false;
        submitForm();
    });

    document.getElementById('exportStructureBtn').addEventListener('click', function() {
        selectNoneEntities();
        ['unit_types', 'unit_type_themes', 'units', 'job_titles'].forEach(entityType => {
            const checkbox = document.querySelector(`input[value="${entityType}"]`);
            if (checkbox) checkbox.checked = true;
        });
        document.getElementById('include_historical').checked = false;
        submitForm();
    });

    // Entity selection helpers
    document.getElementById('selectAllEntities').addEventListener('click', selectAllEntities);
    document.getElementById('selectNoneEntities').addEventListener('click', selectNoneEntities);

    // Format description update
    document.getElementById('export_format').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        if (description) {
            document.getElementById('formatDescription').textContent = description;
        }
    });

    // Cancel button handler
    cancelBtn.addEventListener('click', function() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
        progressModal.hide();
        resetProgress();
    });

    // Close button handler
    closeBtn.addEventListener('click', function() {
        progressModal.hide();
        loadRecentExports(); // Refresh recent exports
    });

    // Download all button handler
    downloadAllBtn.addEventListener('click', function() {
        if (currentOperationId) {
            window.location.href = `/import-export/export/${currentOperationId}/download-all`;
        }
    });

    function selectAllEntities() {
        document.querySelectorAll('input[name="entity_types"]').forEach(cb => cb.checked = true);
    }

    function selectNoneEntities() {
        document.querySelectorAll('input[name="entity_types"]').forEach(cb => cb.checked = false);
    }

    function submitForm() {
        // Validate form
        if (!validateForm()) {
            return;
        }

        // Show progress modal
        progressModal.show();
        resetProgress();
        startTime = Date.now();

        // Prepare form data
        const formData = new FormData(exportForm);
        
        // Get selected entity types
        const selectedEntities = Array.from(document.querySelectorAll('input[name="entity_types"]:checked'))
            .map(cb => cb.value);
        formData.set('entity_types', selectedEntities.join(','));

        progressMessage.textContent = 'Avvio esportazione...';
        progressDetails.textContent = `Esportazione di ${selectedEntities.length} tipi di entità`;

        // Submit form
        fetch('/import-export/export/generate', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentOperationId = data.operation_id;
                startStatusCheck();
            } else {
                throw new Error(data.message || 'Errore durante la generazione');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Errore: ' + error.message);
        });
    }

    function validateForm() {
        // Check entity types selection
        const selectedEntities = document.querySelectorAll('input[name="entity_types"]:checked');
        if (selectedEntities.length === 0) {
            alert('Seleziona almeno un tipo di entità da esportare');
            return false;
        }

        // Validate date range
        const dateFrom = document.getElementById('date_from').value;
        const dateTo = document.getElementById('date_to').value;
        
        if (dateFrom && dateTo && dateFrom > dateTo) {
            alert('La data di inizio deve essere precedente alla data di fine');
            return false;
        }

        // Validate file prefix
        const filePrefix = document.getElementById('file_prefix').value.trim();
        if (!filePrefix) {
            alert('Inserisci un prefisso per il nome del file');
            return false;
        }

        return true;
    }

    function startStatusCheck() {
        if (!currentOperationId) return;

        statusCheckInterval = setInterval(() => {
            fetch(`/import-export/status/${currentOperationId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                    
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(statusCheckInterval);
                        handleOperationComplete(data);
                    }
                })
                .catch(error => {
                    console.error('Status check error:', error);
                    clearInterval(statusCheckInterval);
                    showError('Errore nel controllo stato: ' + error.message);
                });
        }, 1000);
    }

    function updateProgress(data) {
        // Update main progress bar
        progressBar.style.width = data.progress + '%';
        progressBar.setAttribute('aria-valuenow', data.progress);
        progressMessage.textContent = data.message || 'Elaborazione in corso...';

        // Show export stats if progress > 10%
        if (data.progress > 10) {
            exportStats.classList.remove('d-none');
        }

        // Update progress bar styling based on status
        progressBar.className = 'progress-bar bg-success progress-bar-striped';
        if (data.status === 'processing') {
            progressBar.classList.add('progress-bar-animated');
        } else if (data.status === 'completed') {
            progressBar.classList.add('bg-success');
            progressBar.classList.remove('progress-bar-animated');
        } else if (data.status === 'failed') {
            progressBar.classList.add('bg-danger');
            progressBar.classList.remove('progress-bar-animated');
        }

        // Update detailed statistics if available
        if (data.results) {
            const results = data.results;
            if (results.records_exported) {
                recordsExported.textContent = results.total_exported || 0;
            }
            if (results.exported_files) {
                filesGenerated.textContent = results.exported_files.length || 0;
            }
            if (results.total_file_size) {
                totalSize.textContent = formatFileSize(results.total_file_size);
            }
        }

        // Update processing time
        if (startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            processingTime.textContent = elapsed + 's';
        }

        // Update current entity if available
        if (data.current_entity) {
            currentEntity.textContent = data.current_entity;
            if (data.entity_progress) {
                entityProgress.style.width = data.entity_progress + '%';
            }
        }
    }

    function handleOperationComplete(data) {
        // Hide spinner
        progressSpinner.style.display = 'none';
        
        // Update UI based on completion status
        if (data.status === 'completed') {
            progressMessage.textContent = 'Esportazione completata con successo';
            progressDetails.textContent = 'Tutti i file sono stati generati correttamente';
            
            if (data.download_urls && data.download_urls.length > 0) {
                showDownloadLinks(data.download_urls);
                downloadSection.classList.remove('d-none');
                downloadAllBtn.classList.remove('d-none');
            }
        } else if (data.status === 'failed') {
            progressMessage.textContent = 'Esportazione fallita';
            showError(data.error || 'Errore sconosciuto durante l\'esportazione');
        }

        // Show appropriate buttons
        viewStatusBtn.classList.remove('d-none');
        closeBtn.classList.remove('d-none');
        cancelBtn.textContent = 'Chiudi';
    }

    function showDownloadLinks(downloadUrls) {
        downloadLinks.innerHTML = '';
        
        downloadUrls.forEach(download => {
            const downloadBtn = document.createElement('button');
            downloadBtn.type = 'button';
            downloadBtn.className = 'btn btn-outline-success btn-sm d-flex justify-content-between align-items-center';
            downloadBtn.innerHTML = `
                <span>
                    <i class="bi bi-file-earmark-arrow-down me-2"></i>
                    ${download.filename}
                </span>
                <span class="badge bg-light text-dark">${formatFileSize(download.size || 0)}</span>
            `;
            downloadBtn.onclick = function() {
                window.location.href = download.url;
            };
            downloadLinks.appendChild(downloadBtn);
        });
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorSection.classList.remove('d-none');
        progressSpinner.style.display = 'none';
        viewStatusBtn.classList.remove('d-none');
        closeBtn.classList.remove('d-none');
        cancelBtn.textContent = 'Chiudi';
    }

    function resetProgress() {
        progressBar.style.width = '0%';
        progressBar.className = 'progress-bar bg-success progress-bar-striped progress-bar-animated';
        progressMessage.textContent = 'Inizializzazione esportazione...';
        progressDetails.textContent = '';
        progressSpinner.style.display = 'block';
        exportStats.classList.add('d-none');
        downloadSection.classList.add('d-none');
        errorSection.classList.add('d-none');
        viewStatusBtn.classList.add('d-none');
        downloadAllBtn.classList.add('d-none');
        closeBtn.classList.add('d-none');
        cancelBtn.textContent = 'Annulla';
        currentOperationId = null;
        startTime = null;
        
        // Reset stats
        recordsExported.textContent = '0';
        filesGenerated.textContent = '0';
        totalSize.textContent = '0 KB';
        processingTime.textContent = '0s';
        currentEntity.textContent = '-';
        entityProgress.style.width = '0%';
        
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function loadRecentExports() {
        fetch('/import-export/export/recent')
            .then(response => response.json())
            .then(data => {
                const recentExports = document.getElementById('recentExports');
                if (data.exports && data.exports.length > 0) {
                    recentExports.innerHTML = data.exports.map(exp => `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                            <div>
                                <div class="fw-medium">${exp.filename}</div>
                                <small class="text-muted">${exp.created_at}</small>
                            </div>
                            <div>
                                <a href="${exp.download_url}" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                        </div>
                    `).join('');
                } else {
                    recentExports.innerHTML = '<div class="text-muted text-center py-2">Nessuna esportazione recente</div>';
                }
            })
            .catch(error => {
                console.error('Error loading recent exports:', error);
                document.getElementById('recentExports').innerHTML = '<div class="text-muted text-center py-2">Errore nel caricamento</div>';
            });
    }

    // View status button handler
    viewStatusBtn.addEventListener('click', function() {
        if (currentOperationId) {
            window.location.href = `/import-export/status/${currentOperationId}/page`;
        }
    });

    // Load recent exports on page load
    loadRecentExports();

    // Set default date to today for date_to
    const today = new Date();
    document.getElementById('date_to').value = today.toISOString().split('T')[0];
});
</script>
{% endblock %}