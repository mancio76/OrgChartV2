{% extends "base/layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">{{ page_title }}</h1>
                    <p class="text-muted mb-0">{{ page_subtitle }}</p>
                </div>
                <a href="/import-export" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    Torna a Import/Export
                </a>
            </div>
        </div>
    </div>

    <!-- Operation Status Card -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-activity me-2"></i>
                            Stato Operazione
                        </h5>
                        <span class="badge {% if status_info.status == 'completed' %}bg-success{% elif status_info.status == 'failed' %}bg-danger{% elif status_info.status == 'completed_with_errors' %}bg-warning{% else %}bg-primary{% endif %}">
                            {% if status_info.status == 'completed' %}
                                <i class="bi bi-check-circle me-1"></i>Completata
                            {% elif status_info.status == 'failed' %}
                                <i class="bi bi-x-circle me-1"></i>Fallita
                            {% elif status_info.status == 'completed_with_errors' %}
                                <i class="bi bi-exclamation-triangle me-1"></i>Completata con Errori
                            {% elif status_info.status == 'processing' %}
                                <i class="bi bi-hourglass-split me-1"></i>In Elaborazione
                            {% else %}
                                <i class="bi bi-clock me-1"></i>{{ status_info.status|title }}
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Progresso</span>
                            <span class="fw-bold">{{ status_info.progress }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar 
                                {% if status_info.status == 'completed' %}bg-success
                                {% elif status_info.status == 'failed' %}bg-danger
                                {% elif status_info.status == 'completed_with_errors' %}bg-warning
                                {% else %}bg-primary{% endif %}" 
                                role="progressbar" 
                                style="width: {{ status_info.progress }}%"
                                aria-valuenow="{{ status_info.progress }}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <!-- Status Message -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-2">Messaggio di Stato</h6>
                        <p class="mb-0">{{ status_info.message }}</p>
                    </div>

                    <!-- Operation Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Dettagli Operazione</h6>
                            <ul class="list-unstyled">
                                <li><strong>ID Operazione:</strong> {{ operation_id }}</li>
                                <li><strong>Inizio:</strong> {{ status_info.start_time }}</li>
                                {% if status_info.end_time %}
                                <li><strong>Fine:</strong> {{ status_info.end_time }}</li>
                                {% endif %}
                                {% if status_info.filename %}
                                <li><strong>File:</strong> {{ status_info.filename }}</li>
                                {% endif %}
                                {% if status_info.file_format %}
                                <li><strong>Formato:</strong> {{ status_info.file_format|upper }}</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            {% if status_info.entity_types %}
                            <h6 class="text-muted mb-2">Tipi di Entit√†</h6>
                            <div class="d-flex flex-wrap gap-1">
                                {% for entity_type in status_info.entity_types %}
                                <span class="badge bg-secondary">{{ entity_type }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if status_info.validate_only %}
                            <div class="mt-3">
                                <span class="badge bg-info">
                                    <i class="bi bi-eye me-1"></i>Solo Validazione
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Results Summary -->
                    {% if status_info.results %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Riepilogo Risultati</h6>
                        <div class="row">
                            {% if status_info.results.total_records %}
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="h4 mb-1 text-primary">{{ status_info.results.total_records }}</div>
                                    <div class="small text-muted">Record Totali</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if status_info.results.records_created %}
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="h4 mb-1 text-success">{{ status_info.results.records_created.total or 0 }}</div>
                                    <div class="small text-muted">Creati</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if status_info.results.records_updated %}
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="h4 mb-1 text-warning">{{ status_info.results.records_updated.total or 0 }}</div>
                                    <div class="small text-muted">Aggiornati</div>
                                </div>
                            </div>
                            {% endif %}
                            {% if status_info.results.records_skipped %}
                            <div class="col-md-3">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="h4 mb-1 text-secondary">{{ status_info.results.records_skipped.total or 0 }}</div>
                                    <div class="small text-muted">Saltati</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Download Links -->
                    {% if status_info.download_urls %}
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">File Disponibili per Download</h6>
                        <div class="list-group">
                            {% for download in status_info.download_urls %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-earmark-arrow-down me-2 text-success"></i>
                                    <strong>{{ download.filename }}</strong>
                                    {% if download.size %}
                                    <span class="text-muted ms-2">({{ download.size }})</span>
                                    {% endif %}
                                </div>
                                <a href="{{ download.url }}" class="btn btn-success btn-sm">
                                    <i class="bi bi-download me-1"></i>
                                    Scarica
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Auto-refresh for active operations -->
                    {% if status_info.status == 'processing' %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Questa pagina si aggiorna automaticamente ogni 2 secondi durante l'elaborazione.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Errors and Warnings Panel -->
        <div class="col-lg-4">
            {% if status_info.errors %}
            <div class="card border-danger mb-3">
                <div class="card-header bg-danger text-white">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Errori ({{ status_info.errors|length }})
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for error in status_info.errors[:10] %}
                        <div class="list-group-item px-0 py-2 border-0">
                            <small class="text-danger">{{ error }}</small>
                        </div>
                        {% endfor %}
                        {% if status_info.errors|length > 10 %}
                        <div class="list-group-item px-0 py-2 border-0">
                            <small class="text-muted">... e altri {{ status_info.errors|length - 10 }} errori</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if status_info.warnings %}
            <div class="card border-warning mb-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        Avvisi ({{ status_info.warnings|length }})
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for warning in status_info.warnings[:10] %}
                        <div class="list-group-item px-0 py-2 border-0">
                            <small class="text-warning">{{ warning }}</small>
                        </div>
                        {% endfor %}
                        {% if status_info.warnings|length > 10 %}
                        <div class="list-group-item px-0 py-2 border-0">
                            <small class="text-muted">... e altri {{ status_info.warnings|length - 10 }} avvisi</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Preview Data (for validation-only operations) -->
            {% if status_info.results and status_info.results.preview_data %}
            <div class="card border-info">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-eye text-info me-2"></i>
                        Anteprima Dati
                    </h6>
                </div>
                <div class="card-body">
                    {% for entity_type, records in status_info.results.preview_data.items() %}
                    <div class="mb-3">
                        <h6 class="text-primary">{{ entity_type|title }}</h6>
                        <p class="small text-muted mb-2">{{ records|length }} record(s) trovati</p>
                        {% if records %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        {% for key in records[0].keys() %}
                                        <th class="small">{{ key }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in records[:3] %}
                                    <tr>
                                        {% for value in record.values() %}
                                        <td class="small">{{ value|truncate(20) }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                    {% if records|length > 3 %}
                                    <tr>
                                        <td colspan="{{ records[0].keys()|length }}" class="text-center small text-muted">
                                            ... e altri {{ records|length - 3 }} record
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const operationId = '{{ operation_id }}';
    const currentStatus = '{{ status_info.status }}';
    
    // Auto-refresh for active operations
    if (currentStatus === 'processing') {
        const refreshInterval = setInterval(() => {
            fetch(`/import-export/status/${operationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'processing') {
                        // Operation completed, reload page to show final results
                        window.location.reload();
                    } else {
                        // Update progress if still processing
                        updateProgressDisplay(data);
                    }
                })
                .catch(error => {
                    console.error('Status refresh error:', error);
                    clearInterval(refreshInterval);
                });
        }, 2000); // Refresh every 2 seconds
        
        // Clear interval when page is unloaded
        window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
        });
    }
    
    function updateProgressDisplay(data) {
        // Update progress bar
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = data.progress + '%';
            progressBar.setAttribute('aria-valuenow', data.progress);
        }
        
        // Update progress percentage
        const progressText = document.querySelector('.fw-bold');
        if (progressText) {
            progressText.textContent = data.progress + '%';
        }
        
        // Update status message
        const messageElement = document.querySelector('.card-body p');
        if (messageElement && data.message) {
            messageElement.textContent = data.message;
        }
    }
});
</script>
{% endblock %}