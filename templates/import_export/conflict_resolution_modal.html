<!-- Conflict Resolution Modal Template -->
<div class="modal fade" id="conflictResolutionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Risoluzione Conflitti
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                <!-- Conflict Summary -->
                <div class="alert alert-warning mb-4">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-info-circle me-2 mt-1"></i>
                        <div>
                            <h6 class="alert-heading mb-2">Conflitti Rilevati</h6>
                            <p class="mb-2">
                                Sono stati rilevati <strong id="conflictCount">0</strong> record duplicati che richiedono una risoluzione.
                                Scegli come gestire ogni conflitto individualmente o applica una strategia globale.
                            </p>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-warning" id="applyGlobalStrategyBtn">
                                    <i class="bi bi-gear me-1"></i>Strategia Globale
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" id="previewResolutionBtn">
                                    <i class="bi bi-eye me-1"></i>Anteprima Risoluzione
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Strategy Panel -->
                <div id="globalStrategyPanel" class="card mb-4 d-none">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-gear me-2"></i>Strategia Globale
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="globalStrategy" 
                                           id="globalSkip" value="skip">
                                    <label class="form-check-label" for="globalSkip">
                                        <strong>Salta Duplicati</strong>
                                        <br>
                                        <small class="text-muted">Mantieni i record esistenti</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="globalStrategy" 
                                           id="globalUpdate" value="update">
                                    <label class="form-check-label" for="globalUpdate">
                                        <strong>Aggiorna Esistenti</strong>
                                        <br>
                                        <small class="text-muted">Sovrascrivi con nuovi dati</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="globalStrategy" 
                                           id="globalVersion" value="create_version">
                                    <label class="form-check-label" for="globalVersion">
                                        <strong>Crea Versioni</strong>
                                        <br>
                                        <small class="text-muted">Mantieni storico (solo incarichi)</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-sm" id="applyGlobalBtn">
                                <i class="bi bi-check-circle me-1"></i>Applica a Tutti
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="cancelGlobalBtn">
                                <i class="bi bi-x-circle me-1"></i>Annulla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Conflicts List -->
                <div class="conflicts-container" style="max-height: 400px; overflow-y: auto;">
                    <div id="conflictsList">
                        <!-- Conflicts will be populated here -->
                    </div>
                </div>

                <!-- Resolution Summary -->
                <div id="resolutionSummary" class="mt-4 d-none">
                    <div class="card border-success">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Riepilogo Risoluzione
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="resolution-stat">
                                        <div class="resolution-stat-number text-secondary" id="skipCount">0</div>
                                        <div class="resolution-stat-label">Saltati</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="resolution-stat">
                                        <div class="resolution-stat-number text-warning" id="updateCount">0</div>
                                        <div class="resolution-stat-label">Aggiornati</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="resolution-stat">
                                        <div class="resolution-stat-number text-success" id="versionCount">0</div>
                                        <div class="resolution-stat-label">Versioni</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Annulla
                </button>
                <button type="button" class="btn btn-primary" id="confirmResolutionBtn" disabled>
                    <i class="bi bi-check-circle me-2"></i>Conferma Risoluzione
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Conflict Item Template -->
<template id="conflictItemTemplate">
    <div class="conflict-item card mb-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="conflict-info">
                    <h6 class="mb-1">
                        <span class="badge bg-primary conflict-entity-type"></span>
                        <span class="conflict-identifier"></span>
                    </h6>
                    <small class="text-muted conflict-description"></small>
                </div>
                <div class="conflict-status">
                    <span class="badge bg-warning">Non Risolto</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Existing Record -->
                <div class="col-md-6">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-database me-1"></i>Record Esistente
                    </h6>
                    <div class="existing-record-preview">
                        <!-- Existing record data will be populated here -->
                    </div>
                </div>
                
                <!-- New Record -->
                <div class="col-md-6">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-file-earmark-plus me-1"></i>Nuovo Record
                    </h6>
                    <div class="new-record-preview">
                        <!-- New record data will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Resolution Options -->
            <div class="resolution-options mt-3">
                <h6 class="text-muted mb-2">Risoluzione:</h6>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="resolution" value="skip" 
                           id="skip" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="skip">
                        <i class="bi bi-skip-forward me-1"></i>Salta
                    </label>
                    
                    <input type="radio" class="btn-check" name="resolution" value="update" 
                           id="update" autocomplete="off">
                    <label class="btn btn-outline-warning" for="update">
                        <i class="bi bi-arrow-clockwise me-1"></i>Aggiorna
                    </label>
                    
                    <input type="radio" class="btn-check" name="resolution" value="create_version" 
                           id="version" autocomplete="off">
                    <label class="btn btn-outline-success" for="version">
                        <i class="bi bi-plus-circle me-1"></i>Nuova Versione
                    </label>
                </div>
                <div class="resolution-note mt-2 d-none">
                    <small class="text-muted resolution-note-text"></small>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
// Conflict Resolution Modal JavaScript
class ConflictResolutionModal {
    constructor() {
        this.modal = null;
        this.conflicts = [];
        this.resolutions = {};
        this.init();
    }

    init() {
        this.modal = new bootstrap.Modal(document.getElementById('conflictResolutionModal'));
        this.bindEvents();
    }

    bindEvents() {
        // Global strategy toggle
        document.getElementById('applyGlobalStrategyBtn').addEventListener('click', () => {
            this.toggleGlobalStrategyPanel();
        });

        // Global strategy application
        document.getElementById('applyGlobalBtn').addEventListener('click', () => {
            this.applyGlobalStrategy();
        });

        document.getElementById('cancelGlobalBtn').addEventListener('click', () => {
            this.hideGlobalStrategyPanel();
        });

        // Preview resolution
        document.getElementById('previewResolutionBtn').addEventListener('click', () => {
            this.previewResolution();
        });

        // Confirm resolution
        document.getElementById('confirmResolutionBtn').addEventListener('click', () => {
            this.confirmResolution();
        });
    }

    show(conflicts) {
        this.conflicts = conflicts;
        this.resolutions = {};
        this.renderConflicts();
        this.updateSummary();
        this.modal.show();
    }

    hide() {
        this.modal.hide();
    }

    renderConflicts() {
        const conflictsList = document.getElementById('conflictsList');
        const template = document.getElementById('conflictItemTemplate');
        
        conflictsList.innerHTML = '';
        document.getElementById('conflictCount').textContent = this.conflicts.length;

        this.conflicts.forEach((conflict, index) => {
            const conflictElement = template.content.cloneNode(true);
            
            // Populate conflict info
            conflictElement.querySelector('.conflict-entity-type').textContent = conflict.entity_type;
            conflictElement.querySelector('.conflict-identifier').textContent = conflict.identifier;
            conflictElement.querySelector('.conflict-description').textContent = conflict.description;
            
            // Populate existing record
            const existingPreview = conflictElement.querySelector('.existing-record-preview');
            existingPreview.innerHTML = this.renderRecordPreview(conflict.existing_record);
            
            // Populate new record
            const newPreview = conflictElement.querySelector('.new-record-preview');
            newPreview.innerHTML = this.renderRecordPreview(conflict.new_record);
            
            // Set unique IDs for radio buttons
            const radioButtons = conflictElement.querySelectorAll('input[type="radio"]');
            const labels = conflictElement.querySelectorAll('label');
            
            radioButtons.forEach((radio, radioIndex) => {
                const uniqueId = `conflict_${index}_${radio.value}`;
                radio.id = uniqueId;
                radio.name = `conflict_${index}_resolution`;
                labels[radioIndex].setAttribute('for', uniqueId);
                
                radio.addEventListener('change', () => {
                    this.updateResolution(index, radio.value);
                });
            });

            conflictsList.appendChild(conflictElement);
        });
    }

    renderRecordPreview(record) {
        let html = '<div class="record-preview">';
        
        Object.entries(record).forEach(([key, value]) => {
            if (key !== 'id' && value !== null && value !== '') {
                html += `
                    <div class="record-field mb-1">
                        <strong class="field-name">${key}:</strong>
                        <span class="field-value">${this.formatValue(value)}</span>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        return html;
    }

    formatValue(value) {
        if (typeof value === 'string' && value.length > 50) {
            return value.substring(0, 50) + '...';
        }
        return value;
    }

    updateResolution(conflictIndex, resolution) {
        this.resolutions[conflictIndex] = resolution;
        
        // Update conflict status
        const conflictItem = document.querySelectorAll('.conflict-item')[conflictIndex];
        const statusBadge = conflictItem.querySelector('.conflict-status .badge');
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Risolto';
        
        // Show resolution note
        const noteElement = conflictItem.querySelector('.resolution-note');
        const noteText = conflictItem.querySelector('.resolution-note-text');
        
        let noteMessage = '';
        switch (resolution) {
            case 'skip':
                noteMessage = 'Il record esistente verrà mantenuto senza modifiche.';
                break;
            case 'update':
                noteMessage = 'Il record esistente verrà aggiornato con i nuovi dati.';
                break;
            case 'create_version':
                noteMessage = 'Verrà creata una nuova versione mantenendo lo storico.';
                break;
        }
        
        noteText.textContent = noteMessage;
        noteElement.classList.remove('d-none');
        
        this.updateSummary();
        this.checkResolutionComplete();
    }

    updateSummary() {
        const skipCount = Object.values(this.resolutions).filter(r => r === 'skip').length;
        const updateCount = Object.values(this.resolutions).filter(r => r === 'update').length;
        const versionCount = Object.values(this.resolutions).filter(r => r === 'create_version').length;
        
        document.getElementById('skipCount').textContent = skipCount;
        document.getElementById('updateCount').textContent = updateCount;
        document.getElementById('versionCount').textContent = versionCount;
        
        if (skipCount + updateCount + versionCount > 0) {
            document.getElementById('resolutionSummary').classList.remove('d-none');
        }
    }

    checkResolutionComplete() {
        const resolvedCount = Object.keys(this.resolutions).length;
        const totalCount = this.conflicts.length;
        
        const confirmBtn = document.getElementById('confirmResolutionBtn');
        confirmBtn.disabled = resolvedCount < totalCount;
        
        if (resolvedCount === totalCount) {
            confirmBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Conferma Risoluzione';
        } else {
            confirmBtn.innerHTML = `<i class="bi bi-check-circle me-2"></i>Risolvi ${totalCount - resolvedCount} Rimanenti`;
        }
    }

    toggleGlobalStrategyPanel() {
        const panel = document.getElementById('globalStrategyPanel');
        panel.classList.toggle('d-none');
    }

    hideGlobalStrategyPanel() {
        document.getElementById('globalStrategyPanel').classList.add('d-none');
    }

    applyGlobalStrategy() {
        const selectedStrategy = document.querySelector('input[name="globalStrategy"]:checked');
        if (!selectedStrategy) {
            alert('Seleziona una strategia globale');
            return;
        }

        const strategy = selectedStrategy.value;
        
        // Apply strategy to all unresolved conflicts
        this.conflicts.forEach((conflict, index) => {
            if (!(index in this.resolutions)) {
                const radioButton = document.querySelector(`input[name="conflict_${index}_resolution"][value="${strategy}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                    this.updateResolution(index, strategy);
                }
            }
        });

        this.hideGlobalStrategyPanel();
    }

    previewResolution() {
        const preview = {
            total_conflicts: this.conflicts.length,
            resolved_conflicts: Object.keys(this.resolutions).length,
            resolutions: this.resolutions
        };

        console.log('Resolution Preview:', preview);
        
        // Show preview in a simple alert for now
        // In a real implementation, this could show a detailed preview modal
        alert(`Anteprima Risoluzione:\n\nConflitti totali: ${preview.total_conflicts}\nRisolti: ${preview.resolved_conflicts}\n\nDettagli disponibili nella console del browser.`);
    }

    confirmResolution() {
        if (Object.keys(this.resolutions).length < this.conflicts.length) {
            alert('Risolvi tutti i conflitti prima di procedere');
            return;
        }

        // Emit custom event with resolution data
        const event = new CustomEvent('conflictsResolved', {
            detail: {
                conflicts: this.conflicts,
                resolutions: this.resolutions
            }
        });
        
        document.dispatchEvent(event);
        this.hide();
    }
}

// Initialize conflict resolution modal when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.conflictResolutionModal = new ConflictResolutionModal();
});
</script>

<style>
.conflict-item {
    transition: all 0.3s ease;
}

.conflict-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.record-preview {
    background: var(--bs-light);
    border-radius: 0.375rem;
    padding: 0.75rem;
    font-size: 0.85rem;
}

.record-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.field-name {
    color: var(--bs-secondary);
    font-size: 0.8rem;
    min-width: 80px;
}

.field-value {
    text-align: right;
    word-break: break-word;
}

.resolution-stat {
    padding: 0.5rem;
}

.resolution-stat-number {
    font-size: 1.5rem;
    font-weight: 700;
}

.resolution-stat-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--bs-secondary);
}

.btn-check:checked + .btn {
    transform: scale(1.05);
}

.resolution-note {
    background: rgba(13, 202, 240, 0.1);
    border-radius: 0.25rem;
    padding: 0.5rem;
}
</style>